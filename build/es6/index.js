import path from 'path';
import { foundTests, runChild } from './child';
import { runMain } from './main';
import { mkParseArgs } from './lib/parse-cli-args';
const parseArgs = mkParseArgs({
    '--reporter': String,
});
/** Declare a test impl. */
export const test = (name, ...as) => {
    if (typeof as[0] == 'function') {
        if (as.length == 1) {
            foundTests.push({
                name,
                testfn: as[0],
            });
        }
        else {
            foundTests.push({
                name,
                before: as[0],
                testfn: as[1],
                after: as[2],
            });
        }
    }
    else {
        foundTests.push({
            name,
            ...as[0],
        });
    }
};
const argv = process.argv;
// fish out the childrunner start arg
const runConf = (() => {
    const n = argv.indexOf('--child-runner');
    return n >= 0 ? {
        target: argv[n + 1],
    } : null;
})();
/** Switch depending on whether we're the forked child or not. */
if (runConf) {
    // run as child
    require('ts-node').register(); // so we can require .ts-files
    runChild(runConf)
        .catch(e => {
        console.log("Tests failed", e);
        process.exit(1);
    });
}
else {
    const pathToSelf = argv[1]; // 0 is nodejs itself
    const testDir = path.join(process.cwd(), 'test');
    // `loltest some-file --tap` vs `loltest --tap some-file`
    const isPassingFilterFirst = !!argv[2]
        && !argv[2].startsWith('--');
    const filter = argv.slice(2).length > 1
        ? isPassingFilterFirst ? argv[2] : argv[argv.length - 1]
        : isPassingFilterFirst ? argv[2] : undefined;
    const cliArgs = parseArgs(isPassingFilterFirst
        ? argv.slice(3)
        : argv.slice(2, Math.max(argv.length - 1, 3)));
    runMain(pathToSelf, {
        testDir,
        filter,
        reporter: cliArgs['--reporter'],
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQ3hCLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFXLE1BQU0sU0FBUyxDQUFDO0FBQ3hELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDakMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRW5ELE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQztJQUMxQixZQUFZLEVBQUUsTUFBTTtDQUN2QixDQUFDLENBQUM7QUFvQkgsMkJBQTJCO0FBQzNCLE1BQU0sQ0FBQyxNQUFNLElBQUksR0FBaUIsQ0FBQyxJQUFZLEVBQUUsR0FBRyxFQUFPLEVBQUUsRUFBRTtJQUMzRCxJQUFJLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLFVBQVUsRUFBRTtRQUM1QixJQUFJLEVBQUUsQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO1lBQ2hCLFVBQVUsQ0FBQyxJQUFJLENBQUM7Z0JBQ1osSUFBSTtnQkFDSixNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQzthQUNoQixDQUFDLENBQUM7U0FDTjthQUFNO1lBQ0gsVUFBVSxDQUFDLElBQUksQ0FBQztnQkFDWixJQUFJO2dCQUNKLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNiLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNiLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ2YsQ0FBQyxDQUFDO1NBQ047S0FDSjtTQUFNO1FBQ0gsVUFBVSxDQUFDLElBQUksQ0FBQztZQUNaLElBQUk7WUFDSixHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDWCxDQUFDLENBQUM7S0FDTjtBQUNMLENBQUMsQ0FBQztBQUVGLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUM7QUFFMUIscUNBQXFDO0FBQ3JDLE1BQU0sT0FBTyxHQUFtQixDQUFDLEdBQUcsRUFBRTtJQUNsQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDekMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNaLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUN0QixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDYixDQUFDLENBQUMsRUFBRSxDQUFDO0FBRUwsaUVBQWlFO0FBQ2pFLElBQUksT0FBTyxFQUFFO0lBQ1QsZUFBZTtJQUNmLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLDhCQUE4QjtJQUM3RCxRQUFRLENBQUMsT0FBTyxDQUFDO1NBQ1osS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ1AsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDL0IsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNwQixDQUFDLENBQUMsQ0FBQztDQUNWO0tBQU07SUFDSCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxxQkFBcUI7SUFDakQsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFFakQseURBQXlEO0lBQ3pELE1BQU0sb0JBQW9CLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7V0FDL0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRWpDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUM7UUFDbkMsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUN4RCxDQUFDLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBRWpELE1BQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQyxvQkFBb0I7UUFDMUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ2YsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FDaEQsQ0FBQztJQUVGLE9BQU8sQ0FBQyxVQUFVLEVBQUU7UUFDaEIsT0FBTztRQUNQLE1BQU07UUFDTixRQUFRLEVBQUUsT0FBTyxDQUFDLFlBQVksQ0FBQztLQUNsQyxDQUFDLENBQUM7Q0FDTiJ9